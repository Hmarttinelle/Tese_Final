{% extends "calculos/base.html" %}
{% load static %}

{% block title %}Dimensionamento de Vigas{% endblock %}

{% block content %}
    <a href="{% url 'pagina_inicial' %}" class="back-link"><i class="fa-solid fa-arrow-left"></i> Voltar ao Menu</a>
    <h1>Dimensionamento de Viga à Flexão Simples</h1>
    <p>Insira os dados da viga de acordo com a NP EN 1992-1-1.</p>

    <form method="post">
        {% csrf_token %}
        <div class="form-group"><label>Largura (b) [mm]:</label><input type="number" name="b" value="{{ input_data.b|default:'300' }}" required></div>
        <div class="form-group"><label>Altura (h) [mm]:</label><input type="number" name="h" value="{{ input_data.h|default:'500' }}" required></div>
        <div class="form-group">
            <label>Classe do Betão:</label>
            <select name="f_ck">
                <option value="25" {% if input_data.f_ck == '25' or not input_data.f_ck %}selected{% endif %}>C25/30</option>
                </select>
        </div>
        <div class="form-group">
            <label>Classe do Aço:</label>
            <select name="f_yk">
                <option value="500" {% if input_data.f_yk == '500' or not input_data.f_yk %}selected{% endif %}>A500</option>
                </select>
        </div>
        <div class="form-group"><label>Momento (M_Ed) [kNm]:</label><input type="number" step="0.1" name="M_Ed" value="{{ input_data.M_Ed|default:'120' }}" required></div>
        <div class="form-group"><label>Recobrimento (c_nom) [mm]:</label><input type="number" name="c_nom" value="{{ input_data.c_nom|default:'30' }}" required></div>

        <div class="form-actions">
            <button type="submit" class="btn-principal"><i class="fa-solid fa-calculator"></i> Calcular</button>
            <button type="button" id="limparBtn" class="btn-secundario"><i class="fa-solid fa-eraser"></i> Limpar</button>
            <button type="button" onclick="window.print()" class="btn-secundario"><i class="fa-solid fa-file-pdf"></i> Exportar PDF</button>
        </div>
    </form>

    {% if resultado %}
        <div class="resultado {% if resultado.status == 'Sucesso' %}sucesso{% else %}erro{% endif %}">
            <h3>Resultado Final:</h3>
            <p><strong>{{ resultado.mensagem }}</strong></p>
            {% if resultado.status == 'Sucesso' %}
                <p style="font-size: 1.2rem;">
                    <strong>Armadura a adotar: {{ resultado.combinacao_final }} ({{ resultado.As_final_cm2 }} cm²)</strong>
                </p>
            {% endif %}
        </div>
        
        <div class="resultado-detalhado">
            {% if resultado.dados_desenho %}
            <div class="desenho-wrapper">
                <h4>Representação Gráfica da Secção</h4>
                <div id="desenho-container" style="max-width: 400px; margin: 20px auto 0; width: 100%; height: auto; aspect-ratio: {{ resultado.dados_desenho.b|add:150 }} / {{ resultado.dados_desenho.h|add:150 }};"></div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn-secundario" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportarSVG('desenho-container', 'desenho_viga.svg')"><i class="fa-solid fa-file-image"></i> Exportar SVG</button>
                </div>
            </div>
            {% endif %}
            {% if resultado.passos %}
            <div class="passo-a-passo">
                <h4>Cálculo Detalhado (Passo a Passo):</h4>
                <ul>
                    {% for passo in resultado.passos %}
                        <li>
                            <strong>{{ passo.titulo }}</strong>
                            {% if passo.formula %}<div style="margin: 5px 0; color: #005a9c;">Fórmula: \( {{ passo.formula }} \)</div>{% endif %}
                            <div style="margin-left: 10px; line-height: 1.8;">{{ passo.calculo|safe }}</div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <script>
        function exportarSVG(containerId, filename) {
            const container = document.getElementById(containerId);
            if (!container) { console.error("Contentor do SVG não encontrado:", containerId); return; }
            const svgElement = container.querySelector('svg');
            if (!svgElement) { console.error("Elemento SVG não encontrado dentro de:", containerId); return; }
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgElement);
            if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }
            const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
    {% if resultado.dados_desenho and resultado.status == 'Sucesso' %}
        {{ resultado.dados_desenho|json_script:"json-dados-desenho" }}
        <script>
            // Script de desenho da viga
            document.addEventListener('DOMContentLoaded', function() {
                try { const dados = JSON.parse(document.getElementById('json-dados-desenho').textContent); const container = document.getElementById('desenho-container'); if (!dados || !container) return; container.innerHTML = ''; const PADDING = 60; const viewboxWidth = dados.b + PADDING * 2; const viewboxHeight = dados.h + PADDING * 2; const draw = SVG().addTo(container).size('100%', '100%').viewbox(0, 0, viewboxWidth, viewboxHeight); const arrow = draw.marker(10, 10, function(add) { add.path('M0,0 L10,5 L0,10 Z').fill('#333'); }); draw.rect(dados.b, dados.h).move(PADDING, PADDING).fill('#e0e0e0').stroke({ width: 2, color: '#555' }); const estriboX = PADDING + dados.c_nom; const estriboY = PADDING + dados.c_nom; const estriboW = dados.b - 2 * dados.c_nom; const estriboH = dados.h - 2 * dados.c_nom; draw.rect(estriboW, estriboH).move(estriboX, estriboY).fill('none').stroke({ width: dados.phi_estribo / 4, color: '#777' }).radius(dados.phi_estribo * 2); const n_barras = dados.n_barras; const phi_long = dados.phi_long; const y_pos_inf = PADDING + dados.h - dados.c_nom - dados.phi_estribo - (phi_long / 2); const startX_inf = estriboX + (dados.phi_estribo / 2) + (phi_long / 2); const availableWidth = estriboW - dados.phi_estribo - phi_long; const varoes_inf = []; for (let i = 0; i < n_barras; i++) { let x_pos = startX_inf; if (n_barras > 1) { x_pos += i * (availableWidth / (n_barras - 1)); } draw.circle(phi_long).center(x_pos, y_pos_inf).fill('#333'); varoes_inf.push({x: x_pos, y: y_pos_inf}); } const n_barras_sup = 2; const phi_sup = 10; const y_pos_sup = PADDING + dados.c_nom + dados.phi_estribo + (phi_sup / 2); const x1_pos_sup = estriboX + (dados.phi_estribo / 2) + (phi_sup / 2); const x2_pos_sup = estriboX + estriboW - (dados.phi_estribo / 2) - (phi_sup / 2); draw.circle(phi_sup).center(x1_pos_sup, y_pos_sup).fill('#333'); draw.circle(phi_sup).center(x2_pos_sup, y_pos_sup).fill('#333'); draw.line(15, PADDING, 15, PADDING + dados.h).stroke({ width: 1, color: '#333' }).marker('start', arrow).marker('end', arrow); draw.text(String(dados.h)).addClass('dim-text').move(25, PADDING + dados.h / 2).transform({ rotation: -90 }); draw.line(PADDING, 15, PADDING + dados.b, 15).stroke({ width: 1, color: '#333' }).marker('start', arrow).marker('end', arrow); draw.text(String(dados.b)).addClass('dim-text').move(PADDING + dados.b / 2, 25).attr('text-anchor', 'middle'); const label_y_inf = PADDING + dados.h + 30; const first_bar_inf = varoes_inf[0]; draw.path(`M ${first_bar_inf.x},${first_bar_inf.y} L ${first_bar_inf.x},${label_y_inf} L ${first_bar_inf.x + 20},${label_y_inf}`).fill('none').stroke({ width: 1.5, color: '#005a9c' }); draw.text(`${n_barras} Ø ${phi_long}`).addClass('dim-text').fill('#005a9c').move(first_bar_inf.x + 25, label_y_inf - 16); const label_y_sup = PADDING - 30; draw.path(`M ${x1_pos_sup},${y_pos_sup} L ${x1_pos_sup},${label_y_sup} L ${x1_pos_sup + 20},${label_y_sup}`).fill('none').stroke({ width: 1.5, color: '#005a9c' }); draw.text(`${n_barras_sup} Ø ${phi_sup}`).addClass('dim-text').fill('#005a9c').move(x1_pos_sup + 25, label_y_sup - 16); } catch (e) { console.error("Erro ao desenhar o SVG:", e); }
            });
        </script>
    {% endif %}
    <script>
        document.getElementById('limparBtn').addEventListener('click', function() {
            // Script do botão Limpar
            const form = this.closest('form');
            form.querySelector('input[name="b"]').value = '';
            form.querySelector('input[name="h"]').value = '';
            form.querySelector('input[name="M_Ed"]').value = '';
            form.querySelector('input[name="c_nom"]').value = '';
            form.querySelector('select[name="f_ck"]').value = '';
            form.querySelector('select[name="f_yk"]').value = '';
        });
    </script>
{% endblock %}