{% extends "calculos/base.html" %}
{% load static %}

{% block title %}Dimensionamento de Vigas{% endblock %}

{% block content %}
    <a href="{% url 'pagina_inicial' %}" class="back-link"><i class="fa-solid fa-arrow-left"></i> Voltar ao Menu</a>
    <h1>Dimensionamento de Viga à Flexão Simples</h1>
    <p>Insira os dados da viga de acordo com a NP EN 1992-1-1.</p>

    <form method="post">
        {% csrf_token %}
        <div class="form-group"><label>Largura (b) [mm]:</label><input type="number" name="b" value="{{ input_data.b|default:'300' }}" required min="1"></div>
        <div class="form-group"><label>Altura (h) [mm]:</label><input type="number" name="h" value="{{ input_data.h|default:'500' }}" required min="1"></div>
        <div class="form-group">
            <label>Classe do Betão:</label>
            <select name="f_ck">
                <option value="16" {% if input_data.f_ck == '16' %}selected{% endif %}>C16/20</option>
                <option value="20" {% if input_data.f_ck == '20' %}selected{% endif %}>C20/25</option>
                <option value="25" {% if input_data.f_ck == '25' or not input_data.f_ck %}selected{% endif %}>C25/30</option>
                <option value="30" {% if input_data.f_ck == '30' %}selected{% endif %}>C30/37</option>
                <option value="35" {% if input_data.f_ck == '35' %}selected{% endif %}>C35/45</option>
                <option value="40" {% if input_data.f_ck == '40' %}selected{% endif %}>C40/50</option>
                <option value="50" {% if input_data.f_ck == '50' %}selected{% endif %}>C50/60</option>
            </select>
        </div>
        <div class="form-group">
            <label>Classe do Aço:</label>
            <select name="f_yk">
                <option value="500" {% if input_data.f_yk == '500' or not input_data.f_yk %}selected{% endif %}>A500</option>
                </select>
        </div>
        <div class="form-group"><label>Momento (M_Ed) [kNm]:</label><input type="number" step="0.1" name="M_Ed" value="{{ input_data.M_Ed|default:'120' }}" required min="0.1"></div>
        <div class="form-group"><label>Recobrimento (c_nom) [mm]:</label><input type="number" name="c_nom" value="{{ input_data.c_nom|default:'30' }}" required min="1"></div>

        <div class="form-actions">
            <button type="submit" class="btn-principal"><i class="fa-solid fa-calculator"></i> Calcular</button>
            <button type="button" id="limparBtn" class="btn-secundario"><i class="fa-solid fa-eraser"></i> Limpar</button>
        </div>
    </form>

    {% if resultado %}
        <div class="resultado {% if resultado.status == 'Sucesso' %}sucesso{% else %}erro{% endif %}">
            <h3>Resultado Final:</h3>
            <p><strong>{{ resultado.mensagem }}</strong></p>
            {% if resultado.status == 'Sucesso' %}
                <p style="font-size: 1.1rem; margin-bottom: 15px;">
                    <strong>Armadura Ótima a Adotar: {{ resultado.combinacao_final }} ({{ resultado.As_final_cm2 }} cm²)</strong>
                </p>
                <hr style="border: 0; border-top: 1px solid #ccc; margin: 15px 0;">
                <p style="font-size: 0.9rem; color: #555;"><strong>Opções Consideradas:</strong></p>
                {% if resultado.combinacao_mista %}
                    <p style="font-size: 0.9rem; margin: 5px 0;">• <strong>Opção Mista:</strong> {{ resultado.combinacao_mista.combinacao_str }} ({{ resultado.combinacao_mista.As_final_cm2 }} cm²)</p>
                {% endif %}
                {% if resultado.combinacao_unica %}
                    <p style="font-size: 0.9rem; margin: 5px 0;">• <strong>Opção Diâmetro Único:</strong> {{ resultado.combinacao_unica.combinacao_str }} ({{ resultado.combinacao_unica.As_final_cm2 }} cm²)</p>
                {% endif %}
            {% endif %}
        </div>
        
        {% if resultado.status == 'Sucesso' %}
        <div class="form-actions" style="margin-top: 20px; justify-content: center;">
             <a href="{% url 'gerar_relatorio_pdf' resultado.calculo_id %}" target="_blank" class="btn-secundario">
                <i class="fa-solid fa-file-pdf"></i> Gerar Relatório PDF
            </a>
        </div>

        <div class="resultado-detalhado">
            {% if resultado.desenho_svg %}
            <div class="desenho-wrapper">
                <h4>Representação Gráfica da Secção</h4>
                <div id="desenho-container" style="max-width: 400px; margin: 20px auto 0;">
                    {{ resultado.desenho_svg|safe }}
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn-secundario" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportarSVG('desenho-container', 'desenho_viga.svg')"><i class="fa-solid fa-file-image"></i> Exportar SVG</button>
                </div>
            </div>
            {% endif %}
            {% if resultado.passos %}
            <div class="passo-a-passo">
                <h4>Cálculo Detalhado (Passo a Passo):</h4>
                <ul>
                    {% for passo in resultado.passos %}
                        <li>
                            <strong>{{ passo.titulo }}</strong>
                            {% if passo.formula %}<div style="margin: 5px 0; color: #005a9c;">Fórmula: \( {{ passo.formula }} \)</div>{% endif %}
                            <div style="margin-left: 10px; line-height: 1.8;">{{ passo.calculo|safe }}</div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const spinnerOverlay = document.getElementById('spinner-overlay');
            if (form && spinnerOverlay) {
                form.addEventListener('submit', function() {
                    spinnerOverlay.style.display = 'flex';
                });
            }
        });
    </script>
    <script>
        function exportarSVG(containerId, filename) {
            const container = document.getElementById(containerId);
            if (!container) { console.error("Contentor do SVG não encontrado:", containerId); return; }
            const svgElement = container.querySelector('svg');
            if (!svgElement) { console.error("Elemento SVG não encontrado dentro de:", containerId); return; }
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgElement);
            if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }
            const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
    <script>
        document.getElementById('limparBtn').addEventListener('click', function() {
            const form = this.closest('form');
            form.querySelector('input[name="b"]').value = '';
            form.querySelector('input[name="h"]').value = '';
            form.querySelector('input[name="M_Ed"]').value = '';
            form.querySelector('input[name="c_nom"]').value = '';
            form.querySelector('select[name="f_ck"]').value = '25';
            form.querySelector('select[name="f_yk"]').value = '500';
        });
    </script>
{% endblock %}