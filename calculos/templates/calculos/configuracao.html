{% extends "calculos/base.html" %}
{% load static %}

{% block title %}Configurar Sistema{% endblock %}

{% block content %}
    <a href="{% url 'pagina_inicial' %}" class="back-link"><i class="fa-solid fa-arrow-left"></i> Voltar ao Menu</a>
    <h1><i class="fa-solid fa-gears"></i> Configurar Sistema</h1>
    <p>Altere as definições globais de aparência da aplicação.</p>

    <form method="post" enctype="multipart/form-data" class="config-form">
        {% csrf_token %}
        
        <fieldset class="form-section">
            <legend>Aparência Visual</legend>

            <div class="form-group">
                <label>{{ form.theme_mode.label }}</label>
                <div class="theme-selector">
                    {% for radio in form.theme_mode %}
                    <div class="theme-option">
                        {{ radio.tag }}
                        <label for="{{ radio.id_for_label }}">
                            {% if radio.choice_label == 'Claro' %}
                                <i class="fa-solid fa-sun"></i>
                            {% else %}
                                <i class="fa-solid fa-moon"></i>
                            {% endif %}
                            {{ radio.choice_label }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% if form.theme_mode.errors %}
                    <div class="form-error">
                        {% for error in form.theme_mode.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.primary_color.id_for_label }}">{{ form.primary_color.label }}</label>
                <div class="color-picker-wrapper">
                    {{ form.primary_color }}
                    <span id="color-preview" style="background-color: {{ form.primary_color.value|default:'#0d6efd' }};"></span>
                </div>
                 {% if form.primary_color.errors %}
                    <div class="form-error">
                        {% for error in form.primary_color.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </fieldset>

        <fieldset class="form-section">
            <legend>Imagem de Fundo</legend>
            <div class="form-group">
                <label for="{{ form.background_image.id_for_label }}">{{ form.background_image.label }}</label>
                {{ form.background_image }}
                
                <div class="image-preview-container" id="image-preview-container">
                    {% if form.instance.background_image %}
                        <p class="current-image-info">Imagem atual:</p>
                        <img src="{{ form.instance.background_image.url }}" alt="Imagem de fundo atual" class="image-preview">
                    {% else %}
                         <p class="current-image-info">Sem imagem de fundo definida.</p>
                         <img src="" alt="Pré-visualização da nova imagem" class="image-preview" style="display: none;">
                    {% endif %}
                </div>
                
                {% if form.background_image.errors %}
                    <div class="form-error">
                        {% for error in form.background_image.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </fieldset>

        <div class="form-actions">
            <button type="submit" class="btn-principal"><i class="fa-solid fa-save"></i> Guardar Alterações</button>
        </div>
    </form>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Script para a pré-visualização da cor
        const colorInput = document.getElementById('{{ form.primary_color.id_for_label }}');
        const colorPreview = document.getElementById('color-preview');
        if (colorInput && colorPreview) {
            colorInput.addEventListener('input', function() {
                colorPreview.style.backgroundColor = this.value;
            });
        }

        // Script para a pré-visualização da imagem de fundo
        const imageInput = document.getElementById('{{ form.background_image.id_for_label }}');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = imagePreviewContainer.querySelector('.image-preview');
        const currentImageInfo = imagePreviewContainer.querySelector('.current-image-info');

        if (imageInput && imagePreview) {
            imageInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                        if (currentImageInfo) {
                           currentImageInfo.textContent = 'Nova imagem:';
                        }
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>
{% endblock %}