{% extends "calculos/base.html" %}
{% load static %}

{% block title %}Dimensionamento de Pilares{% endblock %}

{% block content %}
    <a href="{% url 'pagina_inicial' %}" class="back-link"><i class="fa-solid fa-arrow-left"></i> Voltar ao Menu</a>
    <h1>Dimensionamento de Pilar à Flexão Composta</h1>
    <p>Insira os dados do pilar para verificação da esbelteza e dimensionamento.</p>

    <form method="post">
        {% csrf_token %}
        <div class="form-group"><label>Largura (b) [mm]:</label><input type="number" name="b" value="{{ input_data.b|default:'300' }}" required min="1"></div>
        <div class="form-group"><label>Altura (h) [mm]:</label><input type="number" name="h" value="{{ input_data.h|default:'400' }}" required min="1"></div>
        <div class="form-group"><label>Comprimento Real (l) [m]:</label><input type="number" step="0.1" name="l" value="{{ input_data.l|default:'3.5' }}" required min="0.1"></div>
        
        <div class="form-group form-group-full">
            <label>Condições de Apoio (Ligações)</label>
            <div class="ligacao-wrapper">
                <div class="ligacao-selector">
                    <span>Topo:</span>
                    <div class="ligacao-options">
                        <label class="{% if input_data.lig_topo == 'artic' or not input_data.lig_topo %}active{% endif %}">
                            <input type="radio" name="lig_topo" value="artic" {% if input_data.lig_topo == 'artic' or not input_data.lig_topo %}checked{% endif %}>
                            <span class="label-text">Articulado</span>
                            <img src="{% static 'calculos/icons/artic.svg' %}" alt="Articulado">
                        </label>
                        <label class="{% if input_data.lig_topo == 'encab' %}active{% endif %}">
                            <input type="radio" name="lig_topo" value="encab" {% if input_data.lig_topo == 'encab' %}checked{% endif %}>
                            <span class="label-text">Encastrado</span>
                            <img src="{% static 'calculos/icons/encab.svg' %}" alt="Encastrado">
                        </label>
                        <label class="{% if input_data.lig_topo == 'livre' %}active{% endif %}">
                            <input type="radio" name="lig_topo" value="livre" {% if input_data.lig_topo == 'livre' %}checked{% endif %}>
                            <span class="label-text">Livre</span>
                            <img src="{% static 'calculos/icons/livre.svg' %}" alt="Livre">
                        </label>
                    </div>
                </div>
                <div class="ligacao-selector">
                    <span>Base:</span>
                    <div class="ligacao-options">
                        <label class="{% if input_data.lig_base == 'artic' %}active{% endif %}">
                            <input type="radio" name="lig_base" value="artic" {% if input_data.lig_base == 'artic' %}checked{% endif %}>
                            <span class="label-text">Articulado</span>
                            <img src="{% static 'calculos/icons/artic.svg' %}" alt="Articulado">
                        </label>
                        <label class="{% if input_data.lig_base == 'encab' or not input_data.lig_base %}active{% endif %}">
                            <input type="radio" name="lig_base" value="encab" {% if input_data.lig_base == 'encab' or not input_data.lig_base %}checked{% endif %}>
                            <span class="label-text">Encastrado</span>
                            <img src="{% static 'calculos/icons/encab.svg' %}" alt="Encastrado">
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Classe do Betão:</label>
            <select name="f_ck" class="form-control">
                <option value="20" {% if input_data.f_ck == '20' %}selected{% endif %}>C20/25</option>
                <option value="25" {% if not input_data.f_ck or input_data.f_ck == '25' %}selected{% endif %}>C25/30</option>
                <option value="30" {% if input_data.f_ck == '30' %}selected{% endif %}>C30/37</option>
                <option value="35" {% if input_data.f_ck == '35' %}selected{% endif %}>C35/45</option>
                <option value="40" {% if input_data.f_ck == '40' %}selected{% endif %}>C40/50</option>
            </select>
        </div>
        <div class="form-group">
            <label>Classe do Aço:</label>
             <select name="f_yk" class="form-control">
                <option value="400" {% if input_data.f_yk == '400' %}selected{% endif %}>A400</option>
                <option value="500" {% if not input_data.f_yk or input_data.f_yk == '500' %}selected{% endif %}>A500</option>
            </select>
        </div>
        <div class="form-group"><label>Esforço Axial (N_Ed) [kN]:</label><input type="number" step="any" name="N_Ed" value="{{ input_data.N_Ed|default:'800' }}" required min="0.1"></div>
        <div class="form-group"><label>Momento 1ª Ordem (M_Ed) [kNm]:</label><input type="number" step="0.1" name="M_Ed" value="{{ input_data.M_Ed|default:'60' }}" required min="0"></div>
        <div class="form-group"><label>Recobrimento (c_nom) [mm]:</label><input type="number" name="c_nom" value="{{ input_data.c_nom|default:'35' }}" required min="1"></div>
        <div class="form-group"><label>Coef. Fluência (φ_ef):</label><input type="number" step="0.1" name="phi_ef" value="{{ input_data.phi_ef|default:'2.0' }}" required min="0"></div>
        
        <div class="form-actions">
            <button type="submit" class="btn-principal"><i class="fa-solid fa-calculator"></i> Calcular</button>
            <button type="button" id="limparBtn" class="btn-secundario"><i class="fa-solid fa-eraser"></i> Limpar</button>
        </div>
    </form>

    {% if resultado %}
        <div class="resultado {% if resultado.status == 'Sucesso' %}sucesso{% else %}erro{% endif %}">
            <h3>Resultado Final:</h3>
            <p><strong>{{ resultado.mensagem }}</strong></p>
            {% if resultado.status == 'Sucesso' %}
                <p style="font-size: 1.1rem; margin-bottom: 15px;">
                    <strong>Armadura Ótima a Adotar: {{ resultado.combinacao_final }} ({{ resultado.As_final_cm2 }} cm²)</strong>
                </p>
                <hr style="border: 0; border-top: 1px solid #ccc; margin: 15px 0;">
                <p style="font-size: 0.9rem; color: #555;"><strong>Opções Consideradas:</strong></p>
                {% if resultado.combinacao_mista %}
                    <p style="font-size: 0.9rem; margin: 5px 0;">• <strong>Opção Mista:</strong> {{ resultado.combinacao_mista.combinacao_str }} ({{ resultado.combinacao_mista.As_final_cm2 }} cm²)</p>
                {% endif %}
                {% if resultado.combinacao_unica %}
                    <p style="font-size: 0.9rem; margin: 5px 0;">• <strong>Opção Diâmetro Único:</strong> {{ resultado.combinacao_unica.combinacao_str }} ({{ resultado.combinacao_unica.As_final_cm2 }} cm²)</p>
                {% endif %}
            {% endif %}
        </div>

        {% if resultado.status == 'Sucesso' %}
        <div class="form-actions" style="margin-top: 20px; justify-content: center;">
             <a href="{% url 'gerar_relatorio_pdf' resultado.calculo_id %}" target="_blank" class="btn-secundario">
                <i class="fa-solid fa-file-pdf"></i> Gerar Relatório PDF
            </a>
        </div>

        <div class="resultado-detalhado">
            {% if resultado.dados_desenho %}
            <div class="desenho-wrapper">
                <h4>Representação Gráfica da Secção</h4>
                <div id="desenho-pilar-container" style="max-width: 400px; margin: 20px auto 0; width: 100%; height: auto; aspect-ratio: {{ resultado.dados_desenho.b|add:150 }} / {{ resultado.dados_desenho.h|add:150 }};"></div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn-secundario" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportarSVG('desenho-pilar-container', 'desenho_pilar.svg')"><i class="fa-solid fa-file-image"></i> Exportar SVG</button>
                </div>
            </div>
            {% endif %}
            {% if resultado.passos %}
            <div class="passo-a-passo">
                <h4>Cálculo Detalhado (Passo a Passo):</h4>
                <ul>
                    {% for passo in resultado.passos %}
                        <li><strong>{{ passo.titulo }}</strong>
                            {% if passo.formula %}<div style="margin: 5px 0; color: #005a9c;">Fórmula: \( {{ passo.formula }} \)</div>{% endif %}
                            <div style="margin-left: 10px; line-height: 1.8;">{{ passo.calculo|safe }}</div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const spinnerOverlay = document.getElementById('spinner-overlay');
            if (form && spinnerOverlay) {
                form.addEventListener('submit', function() {
                    spinnerOverlay.style.display = 'flex';
                });
            }

            // Script para os seletores visuais de ligação
            const radioGroups = document.querySelectorAll('.ligacao-options');
            radioGroups.forEach(group => {
                group.addEventListener('change', function(event) {
                    const labels = group.querySelectorAll('label');
                    labels.forEach(label => label.classList.remove('active'));
                    if (event.target.type === 'radio' && event.target.checked) {
                        event.target.parentElement.classList.add('active');
                    }
                });
            });
        });
    </script>
    <script>
        function exportarSVG(containerId, filename) {
            const container = document.getElementById(containerId);
            if (!container) { console.error("Contentor do SVG não encontrado:", containerId); return; }
            const svgElement = container.querySelector('svg');
            if (!svgElement) { console.error("Elemento SVG não encontrado dentro de:", containerId); return; }
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgElement);
            if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }
            const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
    
    {% if resultado.dados_desenho and resultado.status == 'Sucesso' %}
        {{ resultado.dados_desenho|json_script:"json-dados-pilar" }}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                try {
                    const dados = JSON.parse(document.getElementById('json-dados-pilar').textContent);
                    const container = document.getElementById('desenho-pilar-container');
                    if (!dados || !container) return;
                    container.innerHTML = '';
                    const PADDING = 60; const viewboxWidth = dados.b + PADDING * 2; const viewboxHeight = dados.h + PADDING * 2;
                    const draw = SVG().addTo(container).size('100%', '100%').viewbox(0, 0, viewboxWidth, viewboxHeight);
                    const arrow = draw.marker(10, 10, function(add) { add.path('M0,0 L10,5 L0,10 Z').fill('#333'); });
                    draw.rect(dados.b, dados.h).move(PADDING, PADDING).fill('#e0e0e0').stroke({ width: 2, color: '#555' });
                    const estriboX = PADDING + dados.c_nom; const estriboY = PADDING + dados.c_nom;
                    const estriboW = dados.b - 2 * dados.c_nom; const estriboH = dados.h - 2 * dados.c_nom;
                    draw.rect(estriboW, estriboH).move(estriboX, estriboY).fill('none').stroke({ width: dados.phi_estribo / 2, color: '#777' }).radius(dados.phi_estribo * 2);
                    const posicoes = []; const n_total = dados.n_barras; const phi_long = dados.phi_long;
                    const canto_sup_esq = { x: estriboX + phi_long/2, y: estriboY + phi_long/2 };
                    const canto_sup_dir = { x: estriboX + estriboW - phi_long/2, y: estriboY + phi_long/2 };
                    const canto_inf_esq = { x: estriboX + phi_long/2, y: estriboY + estriboH - phi_long/2 };
                    const canto_inf_dir = { x: estriboX + estriboW - phi_long/2, y: estriboY + estriboH - phi_long/2 };
                    posicoes.push(canto_sup_esq, canto_sup_dir, canto_inf_esq, canto_inf_dir);
                    const n_inter_h = Math.ceil(n_total/2) - 2;
                    if (n_inter_h > 0) {
                        const esp_h = (estriboH - phi_long) / (n_inter_h + 1);
                        for (let i = 1; i <= n_inter_h; i++) {
                            posicoes.push({ x: canto_sup_esq.x, y: canto_sup_esq.y + i * esp_h });
                            posicoes.push({ x: canto_sup_dir.x, y: canto_sup_dir.y + i * esp_h });
                        }
                    }
                    posicoes.forEach(pos => draw.circle(phi_long).center(pos.x, pos.y).fill('#333'));
                    draw.line(15, PADDING, 15, PADDING + dados.h).stroke({ width: 1, color: '#333' }).marker('start', arrow).marker('end', arrow);
                    draw.text(String(dados.h)).addClass('dim-text').move(25, PADDING + dados.h / 2).transform({ rotation: -90 });
                    draw.line(PADDING, 15, PADDING + dados.b, 15).stroke({ width: 1, color: '#333' }).marker('start', arrow).marker('end', arrow);
                    draw.text(String(dados.b)).addClass('dim-text').move(PADDING + dados.b / 2, 25).attr('text-anchor', 'middle');
                } catch (e) { console.error("Erro ao desenhar SVG do pilar:", e); }
            });
        </script>
    {% endif %}

    <script>
        document.getElementById('limparBtn').addEventListener('click', function() {
            const form = this.closest('form');
            form.querySelector('input[name="b"]').value = '';
            form.querySelector('input[name="h"]').value = '';
            form.querySelector('input[name="l"]').value = '';
            form.querySelector('input[name="N_Ed"]').value = '';
            form.querySelector('input[name="M_Ed"]').value = '';
            form.querySelector('input[name="c_nom"]').value = '';
            form.querySelector('input[name="phi_ef"]').value = '';
            // Resetar seletores visuais
            const radios = form.querySelectorAll('.ligacao-options input[type="radio"]');
            radios.forEach(radio => {
                radio.checked = false;
                radio.parentElement.classList.remove('active');
            });
            // Opcional: Re-selecionar os defaults
            form.querySelector('input[name="lig_topo"][value="artic"]').checked = true;
            form.querySelector('input[name="lig_topo"][value="artic"]').parentElement.classList.add('active');
            form.querySelector('input[name="lig_base"][value="encab"]').checked = true;
            form.querySelector('input[name="lig_base"][value="encab"]').parentElement.classList.add('active');

            form.querySelector('select[name="f_ck"]').value = '25';
            form.querySelector('select[name="f_yk"]').value = '500';
        });
    </script>
{% endblock %}