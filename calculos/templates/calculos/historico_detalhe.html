{% extends "calculos/base.html" %}
{% load static %}

{% block title %}Detalhe do Cálculo - {{ calculo.elemento }}{% endblock %}

{% block content %}
    <div class="form-actions" style="margin-bottom: 20px; justify-content: space-between;">
        <a href="{% url 'historico_calculos' %}" class="back-link" style="margin-bottom: 0;"><i class="fa-solid fa-arrow-left"></i> Voltar ao Histórico</a>
        <a href="{% url 'gerar_relatorio_pdf' calculo.id %}" class="btn-secundario" target="_blank">
            <i class="fa-solid fa-file-pdf"></i> Exportar Relatório PDF
        </a>
    </div>

    <h1>Detalhe do Cálculo: {{ calculo.elemento }}</h1>
    <p>Efetuado em: {{ calculo.timestamp|date:"d/m/Y H:i:s" }}</p>

    <div class="resultado-detalhado" style="grid-template-columns: 1fr; gap: 30px;">
        
        <div class="passo-a-passo">
            <h4>Dados de Entrada</h4>
            <ul style="list-style: none; padding-left: 0;">
                {% for item in calculo.input_data_formatado %}
                <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                    <strong>{{ item.label }} {% if item.symbol %}(\({{ item.symbol }}\)){% endif %}:</strong> 
                    {{ item.value }} {{ item.unit }}
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="resultado sucesso" style="margin-top: 0;">
            <h3>Resultado Final:</h3>
            <p><strong>{{ calculo.resultado_final.mensagem }}</strong></p>
            {% if calculo.resultado_final.status == 'Sucesso' %}
                {% if calculo.elemento == 'Viga' or calculo.elemento == 'Pilar' %}
                    <p style="font-size: 1.2rem;">
                        <strong>Armadura a adotar: {{ calculo.resultado_final.combinacao_final }} ({{ calculo.resultado_final.As_final_cm2 }} cm²)</strong>
                    </p>
                {% elif calculo.elemento == 'Sapata' %}
                    <p><strong>Dimensões (A x B x H):</strong> {{ calculo.resultado_final.dimensoes }}</p>
                    <p><strong>Armadura Inferior (Dir. X):</strong> {{ calculo.resultado_final.armadura_x }}</p>
                    <p><strong>Armadura Inferior (Dir. Y):</strong> {{ calculo.resultado_final.armadura_y }}</p>
                {% endif %}
            {% endif %}
        </div>
        
        {% if calculo.resultado_final.dados_desenho %}
        <div class="desenhos-container" style="margin-top: 15px; text-align: center; page-break-inside: avoid;">
            {% if calculo.elemento == 'Viga' %}
            <div class="desenho-wrapper">
                <h4>Representação Gráfica da Secção</h4>
                <div id="desenho-viga-container" style="max-width: 400px; margin: 20px auto 0; width: 100%; height: auto; aspect-ratio: {{ calculo.resultado_final.dados_desenho.b|add:150 }} / {{ calculo.resultado_final.dados_desenho.h|add:150 }};"></div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn-secundario" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportarSVG('desenho-viga-container', 'desenho_viga.svg')"><i class="fa-solid fa-file-image"></i> Exportar SVG</button>
                </div>
            </div>
            {% elif calculo.elemento == 'Pilar' %}
            <div class="desenho-wrapper">
                <h4>Representação Gráfica da Secção</h4>
                <div id="desenho-pilar-container" style="max-width: 400px; margin: 20px auto 0; width: 100%; height: auto; aspect-ratio: {{ calculo.resultado_final.dados_desenho.b|add:150 }} / {{ calculo.resultado_final.dados_desenho.h|add:150 }};"></div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn-secundario" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportarSVG('desenho-pilar-container', 'desenho_pilar.svg')"><i class="fa-solid fa-file-image"></i> Exportar SVG</button>
                </div>
            </div>
            {% elif calculo.elemento == 'Sapata' %}
            <div class="desenho-box" style="display: inline-block; vertical-align: top; width: 100%; max-width: 450px; margin: 10px;">
                <h4>Representação Gráfica (Planta)</h4>
                <div id="desenho-sapata-planta">{{ calculo.desenho_planta_svg|safe }}</div>
                <div style="text-align: center; margin-top: 10px;">
                    <button class="btn-secundario" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportarSVG('desenho-sapata-planta', 'desenho_sapata_planta.svg')"><i class="fa-solid fa-file-image"></i> Exportar SVG</button>
                </div>
            </div>
            <div class="desenho-box" style="display: inline-block; vertical-align: top; width: 100%; max-width: 450px; margin: 10px;">
                <h4>Representação Gráfica (Corte A-A)</h4>
                <div id="desenho-sapata-corte">{{ calculo.desenho_corte_svg|safe }}</div>
                <div style="text-align: center; margin-top: 10px;">
                     <button class="btn-secundario" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportarSVG('desenho-sapata-corte', 'desenho_sapata_corte.svg')"><i class="fa-solid fa-file-image"></i> Exportar SVG</button>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if calculo.resultado_final.passos %}
        <div class="passo-a-passo">
            <h4>Cálculo Detalhado (Passo a Passo):</h4>
            <ul>
                {% for passo in calculo.resultado_final.passos %}
                    <li>
                        <strong>{{ passo.titulo }}</strong>
                        {% if passo.formula %}<div style="margin: 5px 0; color: #005a9c;">Fórmula: \( {{ passo.formula }} \)</div>{% endif %}
                        <div style="margin-left: 10px; line-height: 1.8;">{{ passo.calculo|safe }}</div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    <script>
        function exportarSVG(containerId, filename) {
            const container = document.getElementById(containerId);
            if (!container) { console.error("Contentor do SVG não encontrado:", containerId); return; }
            const svgElement = container.querySelector('svg');
            if (!svgElement) { console.error("Elemento SVG não encontrado dentro de:", containerId); return; }
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgElement);
            if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }
            const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
    
    {% if calculo.resultado_final.dados_desenho and calculo.resultado_final.status == 'Sucesso' %}
        {% if calculo.elemento == 'Viga' %}
            {{ calculo.resultado_final.dados_desenho|json_script:"json-dados-viga" }}
            <script>
                // ... (scripts de desenho inalterados) ...
            </script>
        {% elif calculo.elemento == 'Pilar' %}
            {{ calculo.resultado_final.dados_desenho|json_script:"json-dados-pilar" }}
            <script>
                // ... (scripts de desenho inalterados) ...
            </script>
        {% endif %}
    {% endif %}
{% endblock %}