{% extends "calculos/base.html" %}
{% load static %}

{% block title %}Dimensionamento de Sapatas{% endblock %}

{% block content %}
    <a href="{% url 'pagina_inicial' %}" class="back-link"><i class="fa-solid fa-arrow-left"></i> Voltar ao Menu</a>
    <h1>Dimensionamento de Sapata Isolada</h1>
    <p>Insira os dados da sapata, do pilar e do terreno.</p>

    <form method="post">
        {% csrf_token %}
        
        <h4 class="form-section-title">Dados do Terreno e Materiais</h4>
        <div class="form-group"><label>Tensão Admissível do Solo (σ_adm) [kPa]:</label><input type="number" step="1" name="sigma_adm" value="{{ input_data.sigma_adm|default:'200' }}" required min="1"></div>
        
        <div class="form-group">
            <label>Classe do Betão:</label>
            <select name="f_ck">
                <option value="16" {% if input_data.f_ck == '16' %}selected{% endif %}>C16/20</option>
                <option value="20" {% if input_data.f_ck == '20' %}selected{% endif %}>C20/25</option>
                <option value="25" {% if input_data.f_ck == '25' or not input_data.f_ck %}selected{% endif %}>C25/30</option>
                <option value="30" {% if input_data.f_ck == '30' %}selected{% endif %}>C30/37</option>
                <option value="35" {% if input_data.f_ck == '35' %}selected{% endif %}>C35/45</option>
                <option value="40" {% if input_data.f_ck == '40' %}selected{% endif %}>C40/50</option>
                <option value="50" {% if input_data.f_ck == '50' %}selected{% endif %}>C50/60</option>
            </select>
        </div>

        <div class="form-group">
            <label>Classe do Aço:</label>
            <select name="f_yk">
                <option value="400" {% if input_data.f_yk == '400' %}selected{% endif %}>A400</option>
                <option value="500" {% if input_data.f_yk == '500' or not input_data.f_yk %}selected{% endif %}>A500</option>
            </select>
        </div>

        <div class="form-group"><label>Recobrimento (fundações) [mm]:</label><input type="number" name="c_nom" value="{{ input_data.c_nom|default:'50' }}" required min="1"></div>

        <h4 class="form-section-title">Dimensões e Esforços do Pilar (ELU)</h4>
        <div class="form-group"><label>Largura do Pilar (bp) [mm]:</label><input type="number" name="bp" value="{{ input_data.bp|default:'400' }}" required min="1"></div>
        <div class="form-group"><label>Altura do Pilar (hp) [mm]:</label><input type="number" name="hp" value="{{ input_data.hp|default:'400' }}" required min="1"></div>
        <div class="form-group"><label>Esforço Axial (N_Ed) [kN]:</label><input type="number" step="0.1" name="N_Ed" value="{{ input_data.N_Ed|default:'1200' }}" required min="0.1"></div>
        <div class="form-group"><label>Momento (M_Ed,y) [kNm]:</label><input type="number" step="0.1" name="M_Edy" value="{{ input_data.M_Edy|default:'60' }}" required min="0"></div>
        
        <div class="form-actions">
            <button type="submit" class="btn-principal"><i class="fa-solid fa-calculator"></i> Calcular</button>
            <button type="button" id="limparBtn" class="btn-secundario"><i class="fa-solid fa-eraser"></i> Limpar</button>
        </div>
    </form>

    {% if resultado %}
        <div class="resultado {% if resultado.status == 'Sucesso' %}sucesso{% else %}erro{% endif %}">
            <h3>Resultado Final:</h3>
            <p><strong>{{ resultado.mensagem }}</strong></p>
            {% if resultado.status == 'Sucesso' %}
                <p><strong>Dimensões da Sapata (A x B x H):</strong> {{ resultado.dimensoes }}</p>
                <p><strong>Armadura Inferior (Dir. X):</strong> {{ resultado.armadura_x }}</p>
                <p><strong>Armadura Inferior (Dir. Y):</strong> {{ resultado.armadura_y }}</p>
            {% endif %}
        </div>

        {% if resultado.status == 'Sucesso' %}
        <div class="form-actions" style="margin-top: 20px; justify-content: center;">
             <a href="{% url 'gerar_relatorio_pdf' resultado.calculo_id %}" target="_blank" class="btn-secundario">
                <i class="fa-solid fa-file-pdf"></i> Gerar Relatório PDF
            </a>
        </div>

        <div class="desenhos-container" style="margin-top: 30px; text-align: center;">
            <div class="desenho-box" style="display: inline-block; vertical-align: top; width: 100%; max-width: 450px; margin: 10px;">
                <h4>Representação Gráfica (Planta)</h4>
                <div id="desenho-sapata-planta">{{ resultado.desenho_planta_svg|safe }}</div>
                <div style="text-align: center; margin-top: 10px;">
                    <button class="btn-secundario" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportarSVG('desenho-sapata-planta', 'desenho_sapata_planta.svg')"><i class="fa-solid fa-file-image"></i> Exportar SVG</button>
                </div>
            </div>
            <div class="desenho-box" style="display: inline-block; vertical-align: top; width: 100%; max-width: 450px; margin: 10px;">
                <h4>Representação Gráfica (Corte A-A)</h4>
                <div id="desenho-sapata-corte">{{ resultado.desenho_corte_svg|safe }}</div>
                <div style="text-align: center; margin-top: 10px;">
                     <button class="btn-secundario" style="padding: 5px 10px; font-size: 0.8rem;" onclick="exportarSVG('desenho-sapata-corte', 'desenho_sapata_corte.svg')"><i class="fa-solid fa-file-image"></i> Exportar SVG</button>
                </div>
            </div>
        </div>
        {% endif %}

        {% if resultado.passos %}
        <div class="passo-a-passo" style="margin-top: 20px;">
            <h4>Cálculo Detalhado (Passo a Passo):</h4>
            <ul>
                {% for passo in resultado.passos %}
                    <li>
                        <strong>{{ passo.titulo }}</strong>
                        {% if passo.formula %}<div style="margin: 5px 0; color: #005a9c;">Fórmula: \( {{ passo.formula }} \)</div>{% endif %}
                        <div style="margin-left: 10px; line-height: 1.8;">{{ passo.calculo|safe }}</div>
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const spinnerOverlay = document.getElementById('spinner-overlay');
            if (form && spinnerOverlay) {
                form.addEventListener('submit', function() {
                    spinnerOverlay.style.display = 'flex';
                });
            }
        });
    </script>
    <script>
        function exportarSVG(containerId, filename) {
            const container = document.getElementById(containerId);
            if (!container) { console.error("Contentor do SVG não encontrado:", containerId); return; }
            const svgElement = container.querySelector('svg');
            if (!svgElement) { console.error("Elemento SVG não encontrado dentro de:", containerId); return; }
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svgElement);
            if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }
            const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
    <script>
        document.getElementById('limparBtn').addEventListener('click', function() {
            const form = this.closest('form');
            form.querySelector('input[name="sigma_adm"]').value = '';
            form.querySelector('input[name="c_nom"]').value = '';
            form.querySelector('input[name="bp"]').value = '';
            form.querySelector('input[name="hp"]').value = '';
            form.querySelector('input[name="N_Ed"]').value = '';
            form.querySelector('input[name="M_Edy"]').value = '';
            form.querySelector('select[name="f_ck"]').value = '';
            form.querySelector('select[name="f_yk"]').value = '';
        });
    </script>
{% endblock %}